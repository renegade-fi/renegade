#!/bin/zsh

# Exit if any command fails
set -e

# Enforce arguments passed correctly
# Should be called as `cargo integrate <package-path>` --> 2 args
if [[ $# -lt 2 ]] ; then
    echo 'Invalid! Correct Usage: \n\tcargo integrate <package-path>'
    exit 0
fi

# If the target package needs a devnet, spin one up
# Assumes `cargo integrate` is being run from the root of the repo
uses_devnet=$(cargo metadata --format-version=1 --no-deps | jq -r ".packages[] | select(.name == \"$2\") | .metadata.integration.uses_devnet")
if [[ $uses_devnet == "true" ]]; then
    source ./bin/setup_devnet.zsh
fi

# Use BuildKit
export DOCKER_BUILDKIT=1

# Bring up the compose file for the target package
compose_file="$2"/docker-compose.yml
docker-compose --file $compose_file down --volumes
docker-compose \
  --file $compose_file \
  up \
  --remove-orphans \
  --build \
  --force-recreate \
  --renew-anon-volumes \
  --abort-on-container-exit \
  --timeout 1
